From 95c384247afcb94c75c66f5fe89eb2e8b91539c2 Mon Sep 17 00:00:00 2001
From: The-BB <tun.chen.bo@gmail.com>
Date: Fri, 5 Jan 2024 13:46:51 +0300
Subject: [PATCH] lang/python/python-dbus-fast: bump to 2.21.0

---
 lang/python/python-dbus-fast/Makefile         |  6 ++++--
 .../python-dbus-fast/patches/010-pre.patch    | 20 +++++++++++++++++++
 .../python-dbus-fast/patches/600-post.patch   | 20 +++++++++++++++++++
 3 files changed, 44 insertions(+), 2 deletions(-)
 create mode 100644 lang/python/python-dbus-fast/patches/010-pre.patch
 create mode 100644 lang/python/python-dbus-fast/patches/600-post.patch

diff --git a/lang/python/python-dbus-fast/Makefile b/lang/python/python-dbus-fast/Makefile
index 74b79d9bf..ffffdff00 100644
--- a/lang/python/python-dbus-fast/Makefile
+++ b/lang/python/python-dbus-fast/Makefile
@@ -4,15 +4,17 @@
 # This is free software, licensed under the GNU General Public License v2.
 # See /LICENSE for more information.
 #
+# XXX bump (hass)
+
 include $(TOPDIR)/rules.mk
 
 PKG_NAME:=python-dbus-fast
-PKG_VERSION:=1.91.2
+PKG_VERSION:=2.21.0
 PKG_RELEASE:=1
 
 PYPI_NAME:=dbus-fast
 PYPI_SOURCE_NAME:=dbus_fast
-PKG_HASH:=648b70804da35c92ac44af1d321aeb19df6596dbad362adc2f2507fd99f0f5ae
+PKG_HASH:=f582f6f16791ced6067dab325fae444edf7ce0704315b90c2a473090636a6fe0
 
 PKG_MAINTAINER:=Quintin Hill <stuff@quintin.me.uk>
 PKG_LICENSE:=MIT
diff --git a/lang/python/python-dbus-fast/patches/010-pre.patch b/lang/python/python-dbus-fast/patches/010-pre.patch
new file mode 100644
index 000000000..095181387
--- /dev/null
+++ b/lang/python/python-dbus-fast/patches/010-pre.patch
@@ -0,0 +1,20 @@
+--- a/src/dbus_fast/_private/address.py
++++ b/src/dbus_fast/_private/address.py
+@@ -45,12 +45,11 @@ def parse_address(address_str: str_) ->
+     return addresses
+ 
+ 
+-def get_system_bus_address() -> str:
+-    """Get the system bus address from the environment or return the default."""
+-    return (
+-        os.environ.get("DBUS_SYSTEM_BUS_ADDRESS")
+-        or "unix:path=/var/run/dbus/system_bus_socket"
+-    )
++def get_system_bus_address():
++    if "DBUS_SYSTEM_BUS_ADDRESS" in os.environ:
++        return os.environ["DBUS_SYSTEM_BUS_ADDRESS"]
++    else:
++        return "unix:path=/var/run/dbus/system_bus_socket"
+ 
+ 
+ display_re = re.compile(r".*:([0-9]+)\.?.*")
diff --git a/lang/python/python-dbus-fast/patches/600-post.patch b/lang/python/python-dbus-fast/patches/600-post.patch
new file mode 100644
index 000000000..ea1d0bc1b
--- /dev/null
+++ b/lang/python/python-dbus-fast/patches/600-post.patch
@@ -0,0 +1,20 @@
+--- a/src/dbus_fast/_private/address.py
++++ b/src/dbus_fast/_private/address.py
+@@ -45,11 +45,12 @@ def parse_address(address_str: str_) ->
+     return addresses
+ 
+ 
+-def get_system_bus_address():
+-    if "DBUS_SYSTEM_BUS_ADDRESS" in os.environ:
+-        return os.environ["DBUS_SYSTEM_BUS_ADDRESS"]
+-    else:
+-        return "unix:path=/opt/var/run/dbus/system_bus_socket"
++def get_system_bus_address() -> str:
++    """Get the system bus address from the environment or return the default."""
++    return (
++        os.environ.get("DBUS_SYSTEM_BUS_ADDRESS")
++        or "unix:path=/opt/var/run/dbus/system_bus_socket"
++    )
+ 
+ 
+ display_re = re.compile(r".*:([0-9]+)\.?.*")
-- 
2.30.2

