From a5a56a2e8e30c45066fa2508d287cd8797efc4f8 Mon Sep 17 00:00:00 2001
From: The-BB <tun.chen.bo@gmail.com>
Date: Thu, 9 Mar 2023 17:04:20 +0300
Subject: [PATCH] lang/python/python3-pyroute2: bump to 0.7.5

---
 lang/python/python3-pyroute2/Makefile         | 20 ++++-----
 .../patches/500-fix-paths.patch               | 44 +++++++++++++++++++
 2 files changed, 54 insertions(+), 10 deletions(-)
 create mode 100644 lang/python/python3-pyroute2/patches/500-fix-paths.patch

diff --git a/lang/python/python3-pyroute2/Makefile b/lang/python/python3-pyroute2/Makefile
index 1f8cf55e6..602de91f0 100644
--- a/lang/python/python3-pyroute2/Makefile
+++ b/lang/python/python3-pyroute2/Makefile
@@ -4,15 +4,16 @@
 # This is free software, licensed under the GNU General Public License v2.
 # See /LICENSE for more information.
 #
+# XXX bump
 
 include $(TOPDIR)/rules.mk
 
 PKG_NAME:=python3-pyroute2
-PKG_VERSION:=0.5.16
+PKG_VERSION:=0.7.5
 PKG_RELEASE:=1
 
 PYPI_NAME:=pyroute2
-PKG_HASH:=fe681a2d008cac815b9f287250d69a333fbfc2b2d89c37d58798104057149989
+PKG_HASH:=1eeb2fa3e2543357df0a937a700c5b6761b2aa5284400aed46206470fe5c0be5
 
 PKG_MAINTAINER:=Martin MatÄ›jek <martin.matejek@nic.cz>
 PKG_LICENSE:=GPL-2.0-or-later Apache-2.0
@@ -29,12 +30,13 @@ define Package/python3-pyroute2
   TITLE:=Python netlink library
   URL:=https://github.com/svinota/pyroute2
   DEPENDS:= \
-	  +python3-light \
-	  +python3-distutils \
-	  +python3-logging \
-	  +python3-multiprocessing \
-	  +python3-sqlite3 \
-	  +python3-ctypes
+	+python3-ctypes \
+	+python3-logging \
+	+python3-multiprocessing \
+	+python3-readline \
+	+python3-sqlite3 \
+	+python3-unittest \
+	+python3-urllib
 endef
 
 define Package/python3-pyroute2/description
@@ -43,8 +45,6 @@ define Package/python3-pyroute2/description
   but now it supports many netlink protocols.
 endef
 
-PYTHON3_PKG_SETUP_ARGS:=
-
 $(eval $(call Py3Package,python3-pyroute2))
 $(eval $(call BuildPackage,python3-pyroute2))
 $(eval $(call BuildPackage,python3-pyroute2-src))
diff --git a/lang/python/python3-pyroute2/patches/500-fix-paths.patch b/lang/python/python3-pyroute2/patches/500-fix-paths.patch
new file mode 100644
index 000000000..18bd47741
--- /dev/null
+++ b/lang/python/python3-pyroute2/patches/500-fix-paths.patch
@@ -0,0 +1,44 @@
+--- a/pyroute2/config/__init__.py
++++ b/pyroute2/config/__init__.py
+@@ -49,7 +49,7 @@ AF_NETLINK = getattr(socket, 'AF_NETLINK
+ data_plugins_pkgs = []
+ data_plugins_path = []
+ 
+-netns_path = ['/var/run/netns', '/var/run/docker/netns']
++netns_path = ['/opt/var/run/netns', '/var/run/netns', '/var/run/docker/netns']
+ 
+ entry_points_aliases = {
+     'pyroute2.netlink.exceptions': 'pyroute2.netlink.exceptions'
+--- a/pyroute2/netlink/rtnl/ifinfmsg/__init__.py
++++ b/pyroute2/netlink/rtnl/ifinfmsg/__init__.py
+@@ -559,7 +559,7 @@ class ifinfbase(object):
+ 
+     class netns_fd(nla):
+         fields = [('value', 'I')]
+-        netns_run_dir = '/var/run/netns'
++        netns_run_dir = '/opt/var/run/netns'
+         netns_fd = None
+ 
+         def encode(self):
+--- a/pyroute2/netns/__init__.py
++++ b/pyroute2/netns/__init__.py
+@@ -116,7 +116,7 @@ MNT_DETACH = 0x00000002
+ MS_BIND = 4096
+ MS_REC = 16384
+ MS_SHARED = 1 << 20
+-NETNS_RUN_DIR = '/var/run/netns'
++NETNS_RUN_DIR = '/opt/var/run/netns'
+ 
+ __saved_ns = []
+ __libc = None
+--- a/pyroute2/netns/manager.py
++++ b/pyroute2/netns/manager.py
+@@ -13,7 +13,7 @@ class NetNSManager(Inotify):
+         path = set(path or [])
+         super(NetNSManager, self).__init__(libc, path)
+         if not self.path:
+-            for d in ['/var/run/netns', '/var/run/docker/netns']:
++            for d in ['/opt/var/run/netns', '/var/run/netns', '/var/run/docker/netns']:
+                 try:
+                     self.register_path(d)
+                 except OSError:
-- 
2.30.2

